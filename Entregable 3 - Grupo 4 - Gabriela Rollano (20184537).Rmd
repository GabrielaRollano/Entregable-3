---
title: "Entregable 3 (20184537)"
author: "Gabriela Eliana Rollano Málaga (20184537)"
date: '2022-06-16'
output: html_document
---
```{r}
library(rio)
library(DescTools)
library(ggplot2)
library(moments)
library(Rmisc)
library(e1071)
library(psych)
library(dplyr)
library(gplots)
library(vcd)
library(PMCMRplus)
library(nortest)
library(car)
library(stargazer)
library(lm.beta)
library(gtools)
library(jtools)
library(ggstance)
library(fastDummies)
library(writexl)
library(lmtest)
library(polycor)
library(ggcorrplot)
library(matrixcalc)
library(GPArotation)
#install.packages("lavaan")
library(lavaan)
library(BBmisc)
```

```{r}
vdem = import("V-Dem-CY-Core-v12.rds")
View(vdem)
```


#1. Variable dependiente - Índice de Democracia Liberal (v2x_libdem)
```{r}
summary(vdem$v2x_libdem)
```

```{r}
str(vdem$v2x_libdem)
```

#2. Variables independientes - Gabriela Rollano
#2.1.Autonomía de los Organismos Electorales (v2elembaut_ord)
```{r}
str(vdem$v2elembaut_ord)
summary(vdem$v2elembaut_ord)
```

#2.2 Medios de comunicación escritos o transmitidos críticos del gobierno (v2mecrit_ord)
```{r}
str(vdem$v2mecrit_ord)
summary(vdem$v2mecrit_ord)
```

#2.3. Respeto a Contraargumentos (v2dlcountr_ord)
```{r}
str(vdem$v2dlcountr_ord)
summary(vdem$v2dlcountr_ord)
```

#3. Variables independientes 
#3.1. Organizaciones de Sociedad civil 
#3.1.1. Represión gubernamental de Organizaciones de Sociedad Civil (v2csreprss_ord)
```{r}
str(vdem$v2csreprss_ord)
summary(vdem$v2csreprss_ord)
```

#3.1.2. Control gubernamental sobre Organizaciones de Sociedad Civil (v2cseeorgs_ord)
```{r}
str(vdem$v2cseeorgs_ord)
summary(vdem$v2cseeorgs_ord)
```

#3.1.3. Consulta gubernamental hacia Organizaciones de Sociedad Civil (v2cscnsult_ord)
```{r}
str(vdem$v2cscnsult_ord)
summary(vdem$v2cscnsult_ord)
```

#4. Armar la base de apoyo
```{r}
factor_gabriela = subset(vdem, select = c(country_name, year, v2x_libdem, v2elembaut_ord, v2mecrit_ord, v2dlcountr_ord, v2csreprss_ord, v2cseeorgs_ord, v2cscnsult_ord))
```

```{r}
factor_gabriela = factor_gabriela[factor_gabriela$year==2021,]
```

```{r}
factor_gabriela$country_name = NULL
factor_gabriela$year = NULL
factor_gabriela$v2x_libdem = NULL
```

#I. Análisis Factorial Exploratorio
#5. Explorar las correlaciones entre las variables
```{r}
corMatrix_g = polycor::hetcor(factor_gabriela)$correlations
corMatrix_g
```

#6. Graficar la matriz de correlaciones
```{r}
ggcorrplot(corMatrix_g)
```


#7. Verificar validez del análisis factorial
#7.1. Verificar si variables se pueden factorizar 
Overall MSA es mayor a 0.6, por lo que el análisis factorial es factible.
```{r}
psych::KMO(corMatrix_g)
```
#7.2. Descartar una posible matriz de identidad
Sale FALSE (p-value NO es mayor a 0.05), por lo que el análisis factorial es factible.
```{r}
cortest.bartlett(corMatrix_g, n = nrow(factor_gabriela))$p.value>0.05
```
#7.3. Descartar una posible matriz singular
Sale FALSE, por lo que el análisis factorial es factible.
```{r}
is.singular.matrix(corMatrix_g)
```

#8. Determinar en cuántos factores se pueden agrupar las variables
```{r}
fa.parallel(factor_gabriela, fm = "ML", fa = "fa")
```

#9. Observar las cargas factoriales y ver en qué factores se ubicaría cada variable
```{r}
resfa_g <- fa(factor_gabriela, nfactors = 1, cor = "cor", rotate = "varimax", fm = "minres")
print(resfa_g$loadings, cutoff = 0.5)
```
#10. Graficar cómo se agrupan las variables
```{r}
fa.diagram(resfa_g)
```
```{r}
write.csv(fa.diagram(resfa_g),"resfa_g.csv")

```

#11. Evaluar los resultados obtenidos
#11.1. ¿Qué variables aportaron más a los factores?
```{r}
sort(resfa_g$communality)
```
#12. Observar los posibles valores proyectados
#12.1. Para grabar en la base los puntajes de los factores
```{r}
factor_gabriela$puntaje = resfa_g$scores
```

#II. Análisis Factorial Confirmatorio
#13. Construir un modelo lineal
```{r}
modelog <- ' factorg  =~ v2elembaut_ord + v2mecrit_ord + v2dlcountr_ord + v2csreprss_ord + v2cseeorgs_ord + v2cscnsult_ord'
```
#14. Crear un objeto para hacer las validaciones
```{r}
cfa_fit <- cfa(modelog, data=factor_gabriela, 
           std.lv=TRUE,  
           missing="fiml")
```
#15. Preparar los test para las validaciones
```{r}
allParamCFA=parameterEstimates(cfa_fit,standardized = T)
allFitCFA=as.list(fitMeasures(cfa_fit))
```
#16. Ver si cada variable tiene una buena relación con su factor (p-value menor a 0.05 indica que la variable tiene buena relación con su latente)
```{r}
allParamCFA[allParamCFA$op=="=~",]
```
#17. Ver si la asignación de variables ha relativamente buena (p-value mayor a 0.05 para validar el modelo)
```{r}
allFitCFA[c("chisq", "df", "pvalue")]
```
#18. Otra prueba para ver si el análisis factorial es relativamente bueno (índice Tucker - Lewi debe ser mayor a 0.9)
```{r}
allFitCFA$tli
```
#19. Ver si la raíz del error cuadrático medio de aproximación es menor a 0.05 (ver rmsea)
```{r}
allFitCFA[c('rmsea.ci.lower','rmsea' ,'rmsea.ci.upper')]
```
#20. Hacer predicciones (scores) de las variables latentes
```{r}
scorescfa=normalize(lavPredict(cfa_fit),
                    method = "range", 
                    margin=2, # by column
                    range = c(0, 10))
```
```{r}
factor_gabriela$prediccion = scorescfa
```
```{r}
ggplot(data=factor_gabriela,aes(x=prediccion,y=puntaje)) + geom_point() + theme_minimal()
```





